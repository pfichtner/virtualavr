#!/usr/bin/env bash
set -euo pipefail

compile_arduino_sketch() {
    local sketch_dir="$1"
    local target_filename="$2"

    # Install libraries if libraries.txt exists
    [[ -n "${ENABLE_UNSAFE_INSTALL:-}" ]] && arduino-cli config set library.enable_unsafe_install "${ENABLE_UNSAFE_INSTALL}"

    local libraries_file="$sketch_dir/libraries.txt"
    if [[ -f "$libraries_file" ]]; then
        while IFS= read -r line; do
            line="$(echo "$line" | xargs)"
            [[ -z "$line" || "$line" == \#* ]] && continue

            if [[ "$line" == *"://"* ]] || [[ "$line" == git@* ]]; then
                [[ -n "${ENABLE_UNSAFE_INSTALL:-}" ]] && arduino-cli config set library.enable_unsafe_install "${ENABLE_UNSAFE_INSTALL}"
                arduino-cli lib install --git-url "$line" || echo "Error installing Git library: $line" >&2
            elif [[ "$line" == */* ]] || [[ "$line" == *.zip ]]; then
                [[ -n "${ENABLE_UNSAFE_INSTALL:-}" ]] && arduino-cli config set library.enable_unsafe_install "${ENABLE_UNSAFE_INSTALL}"
                arduino-cli lib install --zip-path "$line" || echo "Error installing ZIP library: $line" >&2
                (
                    cd "$sketch_dir" || { echo "Cannot cd to $sketch_dir" >&2; exit 1; }
                    arduino-cli lib install --zip-path "$line" || echo "Error installing ZIP library: $line" >&2
                )
            else
                arduino-cli lib install "$line" || echo "Error installing library: $line" >&2
        fi

        done < "$libraries_file"
    fi

    # Build parameters
    local fqbn="${BUILD_FQBN:-arduino:avr:uno}"
    local build_property_flag=""

    if [[ -n "${BUILD_EXTRA_FLAGS:-}" ]]; then
        # Preserve flags exactly as passed
        build_property_flag="--build-property build.extra_flags=${BUILD_EXTRA_FLAGS}"
    fi

    local target_dir="$(mktemp -d /tmp/arduino-build-XXXXXX)"

    # Compile
    if ! arduino-cli compile \
        --fqbn "$fqbn" \
        $build_property_flag \
        --output-dir "$target_dir" \
        "$sketch_dir"; then
        echo "Compilation failed" >&2
        rm -rf "$target_dir"
        return 1
    fi

    local sketch_name="$(basename "$sketch_dir")"
    local hex_file="$target_dir/${sketch_name}.ino.hex"

    if [[ ! -f "$hex_file" ]]; then
        echo "HEX file not found: $hex_file" >&2
        rm -rf "$target_dir"
        return 1
    fi

    mv "$hex_file" "$target_filename"

    rm -rf "$target_dir"
}


build_hex() {
    local input_filename="$1"
    local target_filename="$2"

    local tmp_dir
    tmp_dir="$(mktemp -d /tmp/arduino-sketch-XXXXXX)"

    if [[ "$input_filename" == *.hex ]]; then
        cp "$input_filename" "$target_filename"

    elif [[ "$input_filename" == *.zip ]]; then
        local copy_target="$tmp_dir/sketch"
        mkdir -p "$copy_target"

        unzip -q "$input_filename" -d "$copy_target"
        compile_arduino_sketch "$copy_target" "$target_filename"

    elif [[ "$input_filename" == *.ino ]]; then
        local base_name
        base_name="$(basename "$input_filename" .ino)"

        local copy_target="$tmp_dir/$base_name"
        mkdir -p "$copy_target"

        cp -R "$(dirname "$input_filename")/"* "$copy_target/"
        compile_arduino_sketch "$copy_target" "$target_filename"

    elif [[ -d "$input_filename" ]]; then
        local base_name
        base_name="$(basename "$input_filename")"

        local copy_target="$tmp_dir/$base_name"
        mkdir -p "$copy_target"

        cp -R "$input_filename/"* "$copy_target/"
        compile_arduino_sketch "$copy_target" "$target_filename"

    else
        compile_arduino_sketch "$(dirname "$input_filename")" "$target_filename"
    fi
    rm -rf "$tmp_dir"
}

build_hex "$1" "$2"
